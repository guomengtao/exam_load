⚠️ Cursor 协作开发风险提示及规范

为了保证项目代码的稳定性和一致性，使用 Cursor 进行代码生成和修改时请注意以下规范和限制：
	•	修改范围严格限定：Cursor 只能对指定功能模块或文件的新增功能进行增量修改，禁止覆盖或删除已有成熟功能代码，避免出现重大回退或功能丢失。
	•	必须先备份：每次让 Cursor 操作之前，务必先备份相关代码，防止误操作导致数据不可恢复。
	•	明确修改意图：所有修改请求必须附带详细说明，明确指出允许修改的具体文件、功能点及限制，避免模糊导致错误。
	•	禁止全量重写：Cursor 不允许进行大范围代码重写或重构，避免破坏现有稳定逻辑。
	•	增量修正优先：建议采用增量修改方案，逐步完善功能，避免一次性提交大量修改。
	•	多次确认和测试：每次使用 Cursor 生成或修改代码后，必须进行充分的单元测试和整体打包测试，确保功能正常且无回归。
	•	风险识别与隔离：对 Cursor 操作可能带来的风险要有充分识别，必要时设计隔离机制，避免影响其他模块。
	•	协作规范统一：团队成员需共同遵守 Cursor 使用规范，避免不当操作引发冲突。
    
## 🚀 升级新内容

- **软删除逻辑**：生成的 service 层代码现在使用软删除逻辑，通过 `UPDATE` 语句设置 `deleted_at` 字段，确保数据不会从数据库中物理删除。
- **表结构校验**：在生成代码前，会检查表是否包含 `deleted_at` 和 `created_at` 字段，确保生成的代码能够正常运行。
- **路由注册清理**：删除表时，会自动清理 `routes/gen_routes.go` 中对应的 `RegisterXXXRoutes` 行，保持路由文件的整洁。
- **生成器逻辑**：支持通过 `-table=all` 参数批量生成所有需要生成代码的数据库表，提高开发效率。

---

## 📋 使用示例

- **生成所有表的代码**：
  ```bash
  go run utils/gen/gen.go -table=all -cmd=a
  ```

- **删除特定表的代码**：
  ```bash
  go run utils/gen/gen.go -table=xxx -cmd=delete
  ```

---

## 🔍 注意事项

- 确保数据库连接信息正确设置，以便生成器能够访问数据库。
- 生成的代码应遵循项目的编码规范和最佳实践。

---
# 代码生成器升级方案

## 🚀 新增功能概述

1. **软删除逻辑**  
   - 生成的 service 和 biz 层代码中的删除操作改为软删除，使用 `UPDATE` 语句更新 `deleted_at` 时间戳字段，而不是物理删除数据。  
   - 软删除字段名统一为 `deleted_at`，数据被“删除”时，会写入删除时间戳，未删除时为空。  
   - 同时，代码生成器会检查目标表是否包含 `deleted_at` 字段，若缺少，则生成失败并提示，防止软删除功能异常。

2. **表结构完整性检查**  
   - 生成代码前，自动校验表结构是否包含以下必要字段：  
     - `deleted_at` （软删除字段）  
     - `created_at` （创建时间字段）  
   - 如果表缺少上述字段，生成器会提示错误，但在批量生成时，继续生成其他表代码，未通过的表会有单独错误提示。

3. **统一管理生成表名单**  
   - 所有生成的表名称统一维护在配置文件 `utils/gen/config/gen_tables.data`（JSON格式）。  
   - 该文件保存表名、创建时间、更新时间、生成次数等字段。  
   - 新增表时，验证表是否存在后追加到此文件，删除时做软删除处理，避免重复添加。

4. **路由注册动态维护**  
   - 路由文件为 `routes/gen_routes.go`，统一注册所有生成的路由。  
   - 删除某表生成代码时，同步从路由注册文件中删除对应的路由注册记录（非删除整个路由文件，只删除相关注册行）。  
   - 新增和更新时，保证路由注册不重复且唯一。

5. **命令行参数设计**  
   - 支持单表生成或删除，参数格式示例：  
     ```bash
     go run utils/gen/gen.go -table=role -cmd=a          # 生成 role 表所有代码  
     go run utils/gen/gen.go -table=role -cmd=delete     # 删除 role 表所有生成代码  
     go run utils/gen/gen.go -table=all -cmd=a           # 批量生成所有已登记表代码  
     ```  
   - 其中 `-table=all` 是特殊标记，表示批量操作所有登记表，而非表名。

---

## 📋 使用示例

- **生成单个表全部代码**  
  ```bash
  go run utils/gen/gen.go -table=role -cmd=a
  ```

- **删除单个表代码**  
  ```bash
  go run utils/gen/gen.go -table=role -cmd=delete
  ```

- **批量生成所有登记的表代码**  
  ```bash
  go run utils/gen/gen.go -table=all -cmd=a
  ```

---

## ⚠️ 开发及使用注意事项

- **生成器操作前必须校验数据库连接配置，确保能正常访问表结构。**  
- **新增表须先确认表结构符合软删除和时间字段规范，避免生成失败。**  
- **删除表代码时，务必同步清理路由注册文件中对应的路由注册记录，防止残留错误。**  
- **保持 `gen_tables.data` 文件数据唯一、完整，防止重复或遗漏。**  
- **批量生成时，遇到单表生成错误应记录并跳过，保证其他表继续生成。**  
- **模板代码必须更新，确保 service 和 biz 层删除逻辑改为软删除语义。**  
- **所有生成代码应遵循项目统一命名规范和包管理规范，避免后续编译报错。**  
- **建议开发前后频繁执行打包测试，快速发现并修正问题，减少大规模改动后集中爆发错误风险。**  
- **团队协作中建议加入自动化预提交检查脚本，确保每次代码变更都经过基础的生成器检查、lint 和测试。**

---

## 🛠️ 相关文件及模块说明

| 文件路径                            | 描述                                   |
|----------------------------------|--------------------------------------|
| `utils/gen/gen.go`               | 生成器主执行文件，处理命令参数及流程控制     |
| `utils/gen/config/gen_tables.data` | 维护所有登记生成的表信息（JSON格式）           |
| `routes/gen_routes.go`            | 统一管理生成代码对应的路由注册                 |
| `templates/service.tpl`           | 业务层 service 代码模板，需更新软删除逻辑       |
| `templates/biz.tpl`               | 业务层 biz 代码模板，需更新软删除逻辑           |
| `scripts/dev-check.sh`            | 建议用于开发流程的打包、lint、测试整合脚本       |

---

## 💡 额外建议

- 明确团队规范，要求开发者在提交时执行预提交钩子，自动检查生成器相关代码正确性。  
- 设计生成器扩展点，未来方便增加更多自动化修正或规范校验功能。  
- 建议分模块设计生成器功能，方便维护和升级，避免功能混杂。  
- 对于软删除字段名称和类型，做统一规范和文档说明，方便开发和维护。

---

以上内容可作为生成器升级的详细方案和开发指导文档，便于团队成员理解和实施。