# GENERATOR_UPGRADE.md

## 🎯 核心目标：可升级、可维护、可扩展的生成器设计原则

本生成器系统遵循以下核心原则，确保代码生成后的服务在未来依然可维护、可扩展、可升级。

---

## ✅ 核心原则

### 1. **生成代码必须独立**
生成后的业务层、骨架层、模型层代码应完全独立于生成器的模板函数与运行时逻辑，确保未来即使修改模板或生成器逻辑，已生成代码也不会受影响。

### 2. **生成器使用的函数仅限生成阶段**
如 `camelCase` 等函数，仅可在生成过程中使用，不允许输出到最终生成文件中。生成文件中只能包含转换后的具体结果，不能再依赖这些函数。

### 3. **公共函数/库分级**
- ✅ 允许使用的公共包：项目级别全局工具，如数据库连接、日志库、配置库、Redis 操作等。
- ❌ 禁止耦合的公共文件：生成器使用的函数或模板函数（如字段映射、命名转换），不能被生成后的代码调用。

### 4. **service 层业务逻辑与骨架逻辑分离**
- 每个 service 拆分为：
  - `xxx_service.go`: 保留业务逻辑，仅生成一次。
  - `xxx_service_auto.go`: 可被重复覆盖，由生成器维护。

### 5. **字段配置允许重命名**
支持通过 `.meta/` 目录下字段配置文件自定义字段映射与别名。例如：
```json
{
  "file_name": "FileName",
  "file_path": "Path"
}
```

### 6. **生成版本信息注入**
每个生成文件头部添加生成器版本、生成时间，方便后期回溯与维护。

---

## 🛡 升级兼容方案

### 场景：已有 N 个模块，生成器升级后如何处理？
1. ✅ **不影响旧代码**：因其不依赖生成器函数，老代码可继续稳定运行。
2. ✅ **支持增量升级**：允许开发者选择仅生成骨架层，不覆盖已有业务逻辑。
3. ✅ **新字段或接口支持自定义对接**：旧模块如需新功能，可通过骨架层或局部继承方式对接。

---

## 🧩 典型陷阱（需避免）

| 问题 | 后果 |
|------|------|
| 生成文件中调用模板函数 | 升级后函数变更将导致生成代码编译失败 |
| service 文件混写逻辑 | 无法重生成、覆盖冲突 |
| 无版本记录 | 升级追踪困难 |
| 模板结构强依赖 | 一改全崩 |

---

## 🏗 建议结构

```
utils/gen/
├── gen.go
├── meta/
│   ├── field.go
│   └── naming.go  <- 仅供生成器模板使用
```

---

## 📌 结语

生成器的目标不仅是开发效率，更要保障生成代码的长期可用性。遵循本规范，构建一个“可升级不破坏”的基础服务生成体系。

