// Code generated by gen.go. DO NOT EDIT.
package services

import (
	"gin-go-test/app/models"
	"gorm.io/gorm"
)

// UserService 处理User相关的业务逻辑
type UserService struct {
	db *gorm.DB
}

// NewUserService 创建新的UserService实例
func NewUserService(db *gorm.DB) *UserService {
	return &UserService{db: db}
}

// GetCount 获取记录总数
func (s *UserService) GetCount() (int64, error) {
	var count int64
	err := s.db.Model(&models.User{}).Count(&count).Error
	return count, err
}

// List 获取记录列表
func (s *UserService) List(page, pageSize int) ([]models.User, error) {
	var items []models.User
	err := s.db.Offset((page - 1) * pageSize).Limit(pageSize).Find(&items).Error
	return items, err
}

// BatchCreate 批量创建记录
func (s *UserService) BatchCreate(items []models.User) ([]models.User, []error) {
	var errs []error
	var createdItems []models.User

	for _, item := range items {
		if err := s.db.Create(&item).Error; err != nil {
			errs = append(errs, err)
		} else {
			createdItems = append(createdItems, item)
		}
	}

	return createdItems, errs
}

// BatchUpdate 批量更新记录
func (s *UserService) BatchUpdate(items []models.User) ([]models.User, []error) {
	var errs []error
	var updatedItems []models.User

	for _, item := range items {
		var old models.User
		if err := s.db.First(&old, item.Id).Error; err != nil {
			errs = append(errs, err)
			continue
		}
		// 构建只包含有值字段的 map
		updateMap := make(map[string]interface{})
		// TODO: 这里需根据你的字段类型和业务调整，以下为示例
		// if item.Name != "" { updateMap["name"] = item.Name }
		// if item.Age != 0 { updateMap["age"] = item.Age }
		// ...
		// 你可以用反射自动处理，或手动列出所有字段

		// 示例：假设有 Name、Age 字段
		// if item.Name != "" { updateMap["name"] = item.Name }
		// if item.Age != 0 { updateMap["age"] = item.Age }

		if len(updateMap) == 0 {
			updatedItems = append(updatedItems, old)
			continue
		}
		if err := s.db.Model(&old).Updates(updateMap).Error; err != nil {
			errs = append(errs, err)
		} else {
			// 更新后重新查一遍
			s.db.First(&old, item.Id)
			updatedItems = append(updatedItems, old)
		}
	}

	return updatedItems, errs
}

// BatchDelete 批量删除记录
func (s *UserService) BatchDelete(ids []uint) []error {
	var errs []error

	for _, id := range ids {
		if err := s.db.Delete(&models.User{}, id).Error; err != nil {
			errs = append(errs, err)
		}
	}

	return errs
}

func (s *UserService) GetDB() *gorm.DB {
	return s.db
}
