 
package genlib

import (
	"fmt"
	"os"
	"strings"
	"text/template"
		"database/sql"
	meta "gin-go-test/utils/gen/meta"
)

// GenerateControllerWithAppend è·¯ç”±è¿½åŠ ç‰ˆ
func GenerateControllerWithAppend(tableName, moduleName string) error {
	tmplPath := "utils/gen/templates/controller.tpl"
	outputPath := fmt.Sprintf("app/controllers/%s_controller.go", strings.ToLower(tableName))

	controllerName := ToCamelCase(tableName)
	routePath := strings.ToLower(tableName)
	modelName := ToCamelCase(tableName)

	data := map[string]string{
		"ModuleName":     moduleName,
		"ControllerName": controllerName,
		"RoutePath":      routePath,
		"PackageName":    "controllers",
		"TableName":      tableName,
		"ModelName":      modelName,
	}

	tmpl, err := template.ParseFiles(tmplPath)
	if err != nil {
		return fmt.Errorf("åŠ è½½æ¨¡æ¿å¤±è´¥: %v", err)
	}

	outFile, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ–‡ä»¶å¤±è´¥: %v", err)
	}
	defer outFile.Close()

	// æ–‡ä»¶å¤´éƒ¨åŠ è‡ªåŠ¨ç”Ÿæˆæ³¨é‡Š
	outFile.WriteString("// Code generated by gen.go. DO NOT EDIT.\n")

	if err := tmpl.Execute(outFile, data); err != nil {
		return fmt.Errorf("æ¸²æŸ“æ¨¡æ¿å¤±è´¥: %v", err)
	}

	fmt.Println("âœ… æ§åˆ¶å™¨åŠè·¯ç”±å·²ç”Ÿæˆåˆ°:", outputPath)
	fmt.Printf("ğŸš€ è·¯ç”±è®¿é—®ç¤ºä¾‹: /api/%s/\n", routePath)
	return nil
}
// GenerateControllerSkeleton ç”Ÿæˆæ§åˆ¶å™¨éª¨æ¶ï¼ˆcontroller_skeletonï¼‰
func GenerateControllerSkeleton(db *sql.DB, tableName, moduleName string, overwrite bool) error {
	tmplPath := "utils/gen/templates/controller_skeleton.tpl"
	if err := os.MkdirAll("utils/generated/controller", os.ModePerm); err != nil {
		return fmt.Errorf("åˆ›å»ºç›®å½•å¤±è´¥: %v", err)
	}
	outputPath := fmt.Sprintf("utils/generated/controller/%s_skeleton.go", strings.ToLower(tableName))

	controllerName := ToCamelCase(tableName)
	routePath := strings.ToLower(tableName)
	modelName := ToCamelCase(tableName)

	tablePrefix := os.Getenv("TABLE_PREFIX")
	fullTableName := tableName
	if tablePrefix != "" {
		fullTableName = tablePrefix + tableName
	}

	fields, err := meta.FetchTableFields(db, fullTableName)
	if err != nil {
		return fmt.Errorf("è·å–å­—æ®µå¤±è´¥: %v", err)
	}

	data := struct {
		ModuleName     string
		ControllerName string
		RoutePath      string
		PackageName    string
		ModelName      string
		Fields         []meta.Field
	}{
		ModuleName:     moduleName,
		ControllerName: controllerName,
		RoutePath:      routePath,
		PackageName:    "skeleton",
		ModelName:      modelName,
		Fields:         fields,
	}

	// if _, err := os.Stat(outputPath); err == nil && !overwrite {
	// 	fmt.Println("âš ï¸ æ§åˆ¶å™¨éª¨æ¶å·²å­˜åœ¨ï¼Œè·³è¿‡ç”Ÿæˆã€‚")
	// 	return nil
	// }

	tmpl, err := template.ParseFiles(tmplPath)
	if err != nil {
		return fmt.Errorf("åŠ è½½æ¨¡æ¿å¤±è´¥: %v", err)
	}

	outFile, err := os.Create(outputPath)
	if err != nil {
		return fmt.Errorf("åˆ›å»ºæ–‡ä»¶å¤±è´¥: %v", err)
	}
	defer outFile.Close()

	if err := tmpl.Execute(outFile, data); err != nil {
		return fmt.Errorf("æ¸²æŸ“æ¨¡æ¿å¤±è´¥: %v", err)
	}

	fmt.Println("âœ… æ§åˆ¶å™¨éª¨æ¶å·²ç”Ÿæˆåˆ°:", outputPath)
	return nil
}